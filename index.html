<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iStore ÈñÄÂ∏ÇÈä∑ÂîÆÂ†±Ë°®ÂàÜÊûê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .excel-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #21A366 0%, #107C41 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(33, 163, 102, 0.3);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #ffffff;
            flex: 1;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-input-group {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .file-input-group:hover {
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .file-input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #b0b0b0;
        }

        .file-input-group.file-a label {
            color: #4ade80;
        }

        .file-input-group.file-b label {
            color: #fb923c;
        }

        .file-input-group.file-ref label {
            color: #60a5fa;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: 500;
        }

        input[type="file"]::file-selector-button:hover {
            background: #0066dd;
        }

        .analyze-btn {
            width: 100%;
            padding: 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analyze-btn:hover:not(:disabled) {
            background: #0066dd;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
        }

        .analyze-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .store-selector {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: none;
        }

        .store-selector.active {
            display: block;
        }

        .store-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .store-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .store-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .store-btn.active {
            background: #007aff;
            border-color: #007aff;
            color: white;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .summary-label {
            font-size: 13px;
            color: #b0b0b0;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .summary-subvalue {
            font-size: 14px;
            color: #9ca3af;
        }

        .care-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .care-table thead {
            background: rgba(255, 255, 255, 0.05);
        }

        .care-table th,
        .care-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .care-table th {
            color: #b0b0b0;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .care-table td {
            color: #e0e0e0;
            font-size: 15px;
        }

        .care-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .care-table .store-name {
            font-weight: 600;
            color: #ffffff;
        }

        .care-table .rate-value {
            font-weight: 600;
            font-size: 16px;
        }

        .growth {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
        }

        .growth.positive {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .growth.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .growth.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .export-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .export-btn {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 22px;
            }

            .section-title {
                font-size: 20px;
            }

            .care-table {
                font-size: 14px;
            }

            .care-table th,
            .care-table td {
                padding: 12px 8px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <div class="excel-icon">üìä</div>
                <h1>iStore ÈñÄÂ∏ÇÈä∑ÂîÆÂ†±Ë°®ÂàÜÊûê</h1>
            </div>
            
            <div class="upload-grid">
                <div class="file-input-group file-a">
                    <label>üìÅ Â∞çÊØîAÊ™îÊ°à (ÂéªÂπ¥)</label>
                    <input type="file" id="fileA" accept=".xlsx,.xls">
                </div>
                <div class="file-input-group file-b">
                    <label>üìÅ Â∞çÊØîBÊ™îÊ°à (‰ªäÂπ¥)</label>
                    <input type="file" id="fileB" accept=".xlsx,.xls">
                </div>
            </div>
            
            <button class="analyze-btn" id="analyzeBtn" disabled>ÈñãÂßãÂàÜÊûê</button>
        </header>

        <div class="store-selector" id="storeSelector">
            <div class="section-title">üè™ ÈÅ∏ÊìáÈñÄÂ∏Ç</div>
            <div class="store-buttons" id="storeButtons"></div>
        </div>

        <div class="results" id="results">
            <!-- 1. Èä∑ÂîÆÂàÜÊûêÁµêÊûúËàáÂπ¥Â∫¶Â∞çÊØî -->
            <div class="section">
                <div class="section-title">
                    <span>üéØ</span>
                    <span>Èä∑ÂîÆÂàÜÊûêÁµêÊûúËàáÂπ¥Â∫¶Â∞çÊØî</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="care-table" id="categoryComparisonTable">
                        <thead>
                            <tr>
                                <th rowspan="2" style="vertical-align: middle;">ÂìÅÈ†Ö</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">Èä∑ÂîÆÊï∏Èáè</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">Èä∑ÂîÆÈáëÈ°ç</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">ÊØõÂà©È°ç</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">ÊØõÂà©Áéá</th>
                            </tr>
                            <tr>
                                <th>ÂéªÂπ¥</th>
                                <th>‰ªäÂπ¥</th>
                                <th>ÊàêÈï∑Áéá</th>
                                <th>ÂéªÂπ¥</th>
                                <th>‰ªäÂπ¥</th>
                                <th>ÊàêÈï∑Áéá</th>
                                <th>ÂéªÂπ¥</th>
                                <th>‰ªäÂπ¥</th>
                                <th>ÊàêÈï∑Áéá</th>
                                <th>ÂéªÂπ¥</th>
                                <th>‰ªäÂπ¥</th>
                                <th>Â∑ÆÁï∞</th>
                            </tr>
                        </thead>
                        <tbody id="categoryComparisonBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 2. Á∏ΩË®àÊëòË¶Å -->
            <div class="section">
                <div class="section-title">
                    <span>üìà</span>
                    <span>Á∏ΩË®àÊëòË¶Å</span>
                </div>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <!-- 3. Care Áî¢ÂìÅÊê≠ÂîÆÁéáÂàÜÊûê -->
            <div class="section">
                <div class="section-title">
                    <span>üõ°Ô∏è</span>
                    <span>Care Áî¢ÂìÅÊê≠ÂîÆÁéáÂàÜÊûê</span>
                </div>
                <p style="color: #b0b0b0; margin-bottom: 20px; font-size: 14px;">
                    ‚Äª Êê≠ÂîÆÁéá = (ACPP+ + iCPP) / ‰∏ªÊ©üÈä∑ÂîÆÊï∏Èáè √ó 100%
                </p>
                <table class="care-table">
                    <thead>
                        <tr>
                            <th>Áî¢ÂìÅÈ°ûÂà•</th>
                            <th>ÂéªÂπ¥Êï∏Èáè</th>
                            <th>‰ªäÂπ¥Êï∏Èáè</th>
                            <th>Êï∏ÈáèÊàêÈï∑</th>
                            <th>ÂéªÂπ¥ÈáëÈ°ç</th>
                            <th>‰ªäÂπ¥ÈáëÈ°ç</th>
                            <th>ÈáëÈ°çÊàêÈï∑</th>
                            <th>ÂéªÂπ¥Êê≠ÂîÆÁéá</th>
                            <th>‰ªäÂπ¥Êê≠ÂîÆÁéá</th>
                            <th>Â∑ÆÁï∞</th>
                        </tr>
                    </thead>
                    <tbody id="careTableBody"></tbody>
                </table>
            </div>

            <!-- ÂåØÂá∫ÂäüËÉΩ -->
            <div class="export-section">
                <button class="export-btn" onclick="exportToCSV()">üì• ÂåØÂá∫ CSV</button>
            </div>
        </div>
    </div>

    <script>
        let fileAData = null;
        let fileBData = null;
        let referenceData = null;
        let allStoresData = {};
        let currentStore = '75';  // È†êË®≠È°ØÁ§∫ÈñÄÂ∏Ç 75

        const fileAInput = document.getElementById('fileA');
        const fileBInput = document.getElementById('fileB');
        const analyzeBtn = document.getElementById('analyzeBtn');

        const targetCategories = ['CPU', 'iPad', 'iPhone', 'Apple Watch', 'AirPods', 'Audio', 'Care', 'Accy', '3rd Party'];

        fileAInput.addEventListener('change', checkFiles);
        fileBInput.addEventListener('change', checkFiles);
        analyzeBtn.addEventListener('click', analyzeData);

        function checkFiles() {
            analyzeBtn.disabled = !(fileAInput.files.length > 0 && fileBInput.files.length > 0);
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function analyzeData() {
            try {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'ÂàÜÊûê‰∏≠...';

                // Ëá™ÂãïËºâÂÖ•ÂèÉÁÖßË≥áÊñô
                const refResponse = await fetch('data/lizan_reference.xlsx');
                const refArrayBuffer = await refResponse.arrayBuffer();
                const refData = new Uint8Array(refArrayBuffer);
                const wbRef = XLSX.read(refData, { type: 'array' });

                // ËÆÄÂèñÂÖ©ÂÄã‰∏äÂÇ≥ÁöÑÊ™îÊ°à
                const [wbA, wbB] = await Promise.all([
                    readExcelFile(fileAInput.files[0]),
                    readExcelFile(fileBInput.files[0])
                ]);

                // Ëß£ÊûêÂèÉÁÖßË≥áÊñô
                referenceData = parseReferenceData(wbRef);

                // Ëß£ÊûêÈä∑ÂîÆË≥áÊñô
                fileAData = parseSalesData(wbA);
                fileBData = parseSalesData(wbB);

                // ËôïÁêÜÊâÄÊúâÈñÄÂ∏ÇË≥áÊñô
                processAllStores();

                // È°ØÁ§∫ÈñÄÂ∏ÇÈÅ∏ÊìáÂô®
                displayStoreSelector();

                // È†êË®≠È°ØÁ§∫ÈñÄÂ∏Ç 75
                displayStoreData('75');

                document.getElementById('storeSelector').classList.add('active');
                document.getElementById('results').classList.add('active');
                
                analyzeBtn.textContent = 'ÈáçÊñ∞ÂàÜÊûê';
            } catch (error) {
                console.error('ÂàÜÊûêÈåØË™§:', error);
                alert('Ê™îÊ°àÂàÜÊûêÈåØË™§Ôºö' + error.message);
                analyzeBtn.textContent = 'ÈñãÂßãÂàÜÊûê';
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        function parseReferenceData(workbook) {
            const reference = {
                products: {},
                care: {}
            };

            // Ëß£Êûê„ÄåÁ´ãÂ±ï„ÄçÂ∑•‰ΩúË°®
            const lizanSheet = workbook.Sheets['Á´ãÂ±ï'];
            if (lizanSheet) {
                const lizanData = XLSX.utils.sheet_to_json(lizanSheet);
                lizanData.forEach(row => {
                    if (row.Code) {
                        reference.products[row.Code] = {
                            Â§ßÂàÜÈ°û: row['Â§ßÂàÜÈ°û'],
                            ‰∏≠ÂàÜÈ°û: row['‰∏≠ÂàÜÈ°û'],
                            Â∞èÂàÜÈ°û: row['Â∞èÂàÜÈ°û']
                        };
                    }
                });
            }

            // Ëß£Êûê„ÄåCare„ÄçÂ∑•‰ΩúË°®
            const careSheet = workbook.Sheets['Care'];
            if (careSheet) {
                const careData = XLSX.utils.sheet_to_json(careSheet);
                careData.forEach(row => {
                    if (row.Code) {
                        reference.care[row.Code] = {
                            Â§ßÂàÜÈ°û: row['Â§ßÂàÜÈ°û'],
                            ‰∏≠ÂàÜÈ°û: row['‰∏≠ÂàÜÈ°û'],
                            Â∞èÂàÜÈ°û: row['Â∞èÂàÜÈ°û'],
                            class5: row.class5  // CPU, iPad, iPhone, AW, AirPods, Audio
                        };
                    }
                });
            }

            return reference;
        }

        function parseSalesData(workbook) {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet);
            
            return data.map(row => ({
                storeCode: row.store_code_id,
                storeName: row.store_name1,
                productCode: row.product_code,
                productName: row.product_name,
                qty: parseFloat(row.total_qty) || 0,
                amt: parseFloat(row.total_amt_t1) || 0,
                cost: parseFloat(row.total_cost) || 0,
                adjCost: parseFloat(row.total_ADJ_COST) || 0
            }));
        }

        function processAllStores() {
            allStoresData = {};
            
            // Êî∂ÈõÜÊâÄÊúâÈñÄÂ∏ÇÔºà‰ΩøÁî® store_code_idÔºâ
            const storeMap = new Map();
            fileAData.forEach(row => {
                if (row.storeCode && row.storeName) {
                    storeMap.set(row.storeCode, row.storeName);
                }
            });
            fileBData.forEach(row => {
                if (row.storeCode && row.storeName) {
                    storeMap.set(row.storeCode, row.storeName);
                }
            });

            // ËôïÁêÜÊØèÂÄãÈñÄÂ∏Ç
            storeMap.forEach((storeName, storeCode) => {
                const storeDataA = fileAData.filter(r => r.storeCode === storeCode);
                const storeDataB = fileBData.filter(r => r.storeCode === storeCode);
                
                allStoresData[storeCode] = {
                    ...processStoreData(storeDataA, storeDataB),
                    storeName: storeName,
                    storeCode: storeCode
                };
            });
        }

        function processStoreData(dataA, dataB) {
            const result = {
                categories: {},
                careByClass5: {}
            };

            // ÂàùÂßãÂåñÂêÑÂ§ßÂàÜÈ°û
            targetCategories.forEach(category => {
                result.categories[category] = {
                    qtyA: 0,  // A = ÂéªÂπ¥
                    qtyB: 0,  // B = ‰ªäÂπ¥
                    amtA: 0,
                    amtB: 0,
                    costA: 0,
                    costB: 0
                };
            });

            // ÂàùÂßãÂåñ Care ÁöÑ class5 Áµ±Ë®à
            const careClass5List = ['CPU', 'iPad', 'iPhone', 'AW', 'AirPods', 'Audio'];
            careClass5List.forEach(class5 => {
                result.careByClass5[class5] = {
                    qtyA: 0,  // A = ÂéªÂπ¥
                    qtyB: 0,  // B = ‰ªäÂπ¥
                    amtA: 0,
                    amtB: 0
                };
            });

            // Ê†πÊìöÁî¢ÂìÅÂêçÁ®±Êé®Ê∏¨ class5ÔºàÁî®Êñº‰∏çÂú®CareÂ∑•‰ΩúË°®‰∏≠ÁöÑÁî¢ÂìÅÔºâ
            function guessClass5FromName(productName) {
                const name = productName.toUpperCase();
                if (name.includes('MBA') || name.includes('MBP') || name.includes('MAC MINI') || 
                    name.includes('IMAC') || name.includes('MAC PRO') || name.includes('MACBOOK')) {
                    return 'CPU';
                }
                if (name.includes('IPAD')) return 'iPad';
                if (name.includes('IPHONE')) return 'iPhone';
                if (name.includes('WATCH') || name.includes(' AW ')) return 'AW';
                if (name.includes('AIRPODS')) return 'AirPods';
                if (name.includes('HOMEPOD') || name.includes('BEATS')) return 'Audio';
                return null;
            }

            // ËôïÁêÜÂ∞çÊØîAÔºàÂéªÂπ¥Ôºâ
            dataA.forEach(row => {
                // ÂÖàÂæûÁ´ãÂ±ïÂ∑•‰ΩúË°®Ê™¢Êü•ÊòØÂê¶ÁÇ∫CareÁî¢ÂìÅ
                const refData = referenceData.products[row.productCode];
                
                if (refData && refData['Â§ßÂàÜÈ°û'] === 'Care') {
                    // ÊòØ Care Áî¢ÂìÅ
                    let class5 = null;
                    
                    // ÂÑ™ÂÖàÂæûCareÂ∑•‰ΩúË°®ÂèñÂæóclass5
                    if (referenceData.care[row.productCode]) {
                        class5 = referenceData.care[row.productCode].class5;
                    } else {
                        // Â¶ÇÊûú‰∏çÂú®CareÂ∑•‰ΩúË°®‰∏≠ÔºåÊ†πÊìöÁî¢ÂìÅÂêçÁ®±Êé®Ê∏¨
                        class5 = guessClass5FromName(row.productName);
                    }
                    
                    if (class5 && result.careByClass5[class5]) {
                        result.careByClass5[class5].qtyA += row.qty;
                        result.careByClass5[class5].amtA += row.amt;
                    }
                    
                    // Care ‰πüË¶ÅË®àÂÖ•Â§ßÂàÜÈ°ûÁµ±Ë®à
                    result.categories['Care'].qtyA += row.qty;
                    result.categories['Care'].amtA += row.amt;
                    result.categories['Care'].costA += row.cost;
                    result.categories['Care'].costA -= row.adjCost;
                } else if (refData) {
                    // ‰∏çÊòØ Care Áî¢ÂìÅ
                    const category = refData['Â§ßÂàÜÈ°û'];
                    
                    if (result.categories[category]) {
                        result.categories[category].qtyA += row.qty;
                        result.categories[category].amtA += row.amt;
                        result.categories[category].costA += row.cost;
                        result.categories[category].costA -= row.adjCost;
                    }
                }
            });

            // ËôïÁêÜÂ∞çÊØîBÔºà‰ªäÂπ¥Ôºâ
            dataB.forEach(row => {
                const refData = referenceData.products[row.productCode];
                
                if (refData && refData['Â§ßÂàÜÈ°û'] === 'Care') {
                    let class5 = null;
                    
                    if (referenceData.care[row.productCode]) {
                        class5 = referenceData.care[row.productCode].class5;
                    } else {
                        class5 = guessClass5FromName(row.productName);
                    }
                    
                    if (class5 && result.careByClass5[class5]) {
                        result.careByClass5[class5].qtyB += row.qty;
                        result.careByClass5[class5].amtB += row.amt;
                    }
                    
                    result.categories['Care'].qtyB += row.qty;
                    result.categories['Care'].amtB += row.amt;
                    result.categories['Care'].costB += row.cost;
                    result.categories['Care'].costB -= row.adjCost;
                } else if (refData) {
                    const category = refData['Â§ßÂàÜÈ°û'];
                    
                    if (result.categories[category]) {
                        result.categories[category].qtyB += row.qty;
                        result.categories[category].amtB += row.amt;
                        result.categories[category].costB += row.cost;
                        result.categories[category].costB -= row.adjCost;
                    }
                }
            });

            return result;
        }

        function displayStoreSelector() {
            const storeButtons = document.getElementById('storeButtons');
            storeButtons.innerHTML = '';

            // Âè™È°ØÁ§∫ÊåáÂÆöÁöÑÈñÄÂ∏ÇÔºà‰∏çÂåÖÂê´ÂÖ®Á§æÔºâ
            const targetStores = ['75', '76', '77', '81', '84'];

            targetStores.forEach(storeCode => {
                if (!allStoresData[storeCode]) return;  // Â¶ÇÊûúË©≤ÈñÄÂ∏ÇÊ≤íÊúâË≥áÊñôÂâáË∑≥ÈÅé
                
                const btn = document.createElement('button');
                btn.className = storeCode === '75' ? 'store-btn active' : 'store-btn';  // È†êË®≠ÈÅ∏‰∏≠ÈñÄÂ∏Ç75
                btn.textContent = storeCode;
                btn.onclick = () => selectStore(storeCode);
                storeButtons.appendChild(btn);
            });
        }

        function selectStore(storeCode) {
            currentStore = storeCode;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.store-btn').forEach(btn => {
                const btnCode = btn.textContent.split(' ')[0];
                btn.classList.toggle('active', btnCode === storeCode);
            });

            displayStoreData(storeCode);
        }

        function displayStoreData(storeCode) {
            const data = allStoresData[storeCode];
            if (!data) return;

            displayCategoryComparison(data);
            displaySummary(data);
            displayCareAnalysis(data);
        }

        function displayCategoryComparison(data) {
            const tbody = document.getElementById('categoryComparisonBody');
            tbody.innerHTML = '';

            // Ë®àÁÆóÁ∏ΩË®àÔºàÊéíÈô§ CareÔºâ
            let totalQtyA = 0, totalQtyB = 0, totalAmtA = 0, totalAmtB = 0;
            let totalProfitA = 0, totalProfitB = 0;
            
            targetCategories.forEach(category => {
                if (category === 'Care') return;
                
                const stats = data.categories[category];
                totalQtyA += stats.qtyA;  // A = ÂéªÂπ¥
                totalQtyB += stats.qtyB;  // B = ‰ªäÂπ¥
                totalAmtA += stats.amtA;
                totalAmtB += stats.amtB;
                totalProfitA += (stats.amtA - stats.costA);
                totalProfitB += (stats.amtB - stats.costB);
            });

            // È°ØÁ§∫ÂêÑÂàÜÈ°û
            targetCategories.forEach(category => {
                const stats = data.categories[category];
                
                // ÊàêÈï∑Áéá = (‰ªäÂπ¥ - ÂéªÂπ¥) / ÂéªÂπ¥ * 100
                const qtyGrowth = stats.qtyA !== 0 ? ((stats.qtyB - stats.qtyA) / stats.qtyA * 100) : 0;
                const amtGrowth = stats.amtA !== 0 ? ((stats.amtB - stats.amtA) / stats.amtA * 100) : 0;
                const profitA = stats.amtA - stats.costA;  // ÂéªÂπ¥ÊØõÂà©
                const profitB = stats.amtB - stats.costB;  // ‰ªäÂπ¥ÊØõÂà©
                const profitGrowth = profitA !== 0 ? ((profitB - profitA) / profitA * 100) : 0;
                const profitRateA = stats.amtA > 0 ? (profitA / stats.amtA * 100) : 0;  // ÂéªÂπ¥ÊØõÂà©Áéá
                const profitRateB = stats.amtB > 0 ? (profitB / stats.amtB * 100) : 0;  // ‰ªäÂπ¥ÊØõÂà©Áéá
                const profitRateDiff = profitRateB - profitRateA;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="store-name">${category}</td>
                    <td>${Math.round(stats.qtyA).toLocaleString()}</td>
                    <td>${Math.round(stats.qtyB).toLocaleString()}</td>
                    <td>${formatGrowth(qtyGrowth)}</td>
                    <td>${Math.round(stats.amtA).toLocaleString()}</td>
                    <td>${Math.round(stats.amtB).toLocaleString()}</td>
                    <td>${formatGrowth(amtGrowth)}</td>
                    <td>${Math.round(profitA).toLocaleString()}</td>
                    <td>${Math.round(profitB).toLocaleString()}</td>
                    <td>${formatGrowth(profitGrowth)}</td>
                    <td>${profitRateA.toFixed(2)}%</td>
                    <td>${profitRateB.toFixed(2)}%</td>
                    <td>${formatDifference(profitRateDiff)}</td>
                `;
                tbody.appendChild(row);
            });

            // Âä†ÂÖ•Á∏ΩË®àÂàó
            const totalQtyGrowth = totalQtyA !== 0 ? ((totalQtyB - totalQtyA) / totalQtyA * 100) : 0;
            const totalAmtGrowth = totalAmtA !== 0 ? ((totalAmtB - totalAmtA) / totalAmtA * 100) : 0;
            const totalProfitGrowth = totalProfitA !== 0 ? ((totalProfitB - totalProfitA) / totalProfitA * 100) : 0;
            const totalProfitRateA = totalAmtA > 0 ? (totalProfitA / totalAmtA * 100) : 0;
            const totalProfitRateB = totalAmtB > 0 ? (totalProfitB / totalAmtB * 100) : 0;
            const totalProfitRateDiff = totalProfitRateB - totalProfitRateA;

            const totalRow = document.createElement('tr');
            totalRow.style.background = 'rgba(255, 255, 255, 0.08)';
            totalRow.style.fontWeight = '600';
            totalRow.innerHTML = `
                <td class="store-name">Á∏ΩË®à (ÊéíÈô§Care)</td>
                <td>${Math.round(totalQtyA).toLocaleString()}</td>
                <td>${Math.round(totalQtyB).toLocaleString()}</td>
                <td>${formatGrowth(totalQtyGrowth)}</td>
                <td>${Math.round(totalAmtA).toLocaleString()}</td>
                <td>${Math.round(totalAmtB).toLocaleString()}</td>
                <td>${formatGrowth(totalAmtGrowth)}</td>
                <td>${Math.round(totalProfitA).toLocaleString()}</td>
                <td>${Math.round(totalProfitB).toLocaleString()}</td>
                <td>${formatGrowth(totalProfitGrowth)}</td>
                <td>${totalProfitRateA.toFixed(2)}%</td>
                <td>${totalProfitRateB.toFixed(2)}%</td>
                <td>${formatDifference(totalProfitRateDiff)}</td>
            `;
            tbody.appendChild(totalRow);
        }

        function displaySummary(data) {
            const container = document.getElementById('summaryGrid');
            
            // Ë®àÁÆóÁ∏ΩË®àÔºàÊéíÈô§ CareÔºâ
            let totalAmtA = 0, totalAmtB = 0, totalCostA = 0, totalCostB = 0;
            
            targetCategories.forEach(category => {
                if (category === 'Care') return;
                const stats = data.categories[category];
                totalAmtA += stats.amtA;  // A = ÂéªÂπ¥
                totalAmtB += stats.amtB;  // B = ‰ªäÂπ¥
                totalCostA += stats.costA;
                totalCostB += stats.costB;
            });
            
            const profitA = totalAmtA - totalCostA;  // ÂéªÂπ¥ÊØõÂà©
            const profitB = totalAmtB - totalCostB;  // ‰ªäÂπ¥ÊØõÂà©
            const profitGrowth = profitA !== 0 ? ((profitB - profitA) / profitA * 100).toFixed(1) : 0;
            const profitGrowthClass = profitGrowth > 0 ? 'positive' : profitGrowth < 0 ? 'negative' : 'neutral';
            const profitSign = profitGrowth > 0 ? '+' : '';

            container.innerHTML = `
                <div class="summary-card">
                    <div class="summary-label">ÂéªÂπ¥Èä∑ÂîÆÈ°ç</div>
                    <div class="summary-value" style="color: #fb923c;">
                        ${(totalAmtA / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})}K
                    </div>
                    <div class="summary-subvalue">Â∞çÊØîA</div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">‰ªäÂπ¥Èä∑ÂîÆÈ°ç</div>
                    <div class="summary-value" style="color: #4ade80;">
                        ${(totalAmtB / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})}K
                    </div>
                    <div class="summary-subvalue">Â∞çÊØîB</div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">‰ªäÂπ¥ÊØõÂà©</div>
                    <div class="summary-value" style="color: #60a5fa;">
                        ${(profitB / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})}K
                    </div>
                    <div class="summary-subvalue">ÊØõÂà©Áéá ${totalAmtB > 0 ? (profitB / totalAmtB * 100).toFixed(1) : 0}%</div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">ÊØõÂà©ÊàêÈï∑</div>
                    <div class="summary-value">
                        <span class="growth ${profitGrowthClass}">${profitSign}${profitGrowth}%</span>
                    </div>
                    <div class="summary-subvalue">Âπ¥Â∫¶Â∞çÊØî</div>
                </div>
            `;
        }

        function displayCareAnalysis(data) {
            const tbody = document.getElementById('careTableBody');
            tbody.innerHTML = '';

            // Care ‰∫ßÂìÅÂØπÂ∫î - Ê≥®ÊÑèÔºöAudio class5 ÂåÖÂê´ÊâÄÊúâÈü≥È¢ë‰∫ßÂìÅÔºàAirPods, HomePodÁ≠âÔºâ
            const careProducts = [
                { name: 'CPU', class5: 'CPU', mainCategory: 'CPU' },
                { name: 'iPad', class5: 'iPad', mainCategory: 'iPad' },
                { name: 'iPhone', class5: 'iPhone', mainCategory: 'iPhone' },
                { name: 'Apple Watch', class5: 'AW', mainCategory: 'Apple Watch' },
                { name: 'AirPods', class5: 'Audio', mainCategory: 'AirPods' }  // Audio class5 ‚Üí ÊòæÁ§∫‰∏∫ AirPods
            ];

            // ÊÄªËÆ°ÂèòÊï∞
            let totalCareQtyA = 0, totalCareQtyB = 0, totalCareAmtA = 0, totalCareAmtB = 0;
            let totalMainQtyA = 0, totalMainQtyB = 0;

            careProducts.forEach(product => {
                // ‰ªé careByClass5 ÂèñÂæó Care Êï∞ÈáèÂíåÈáëÈ¢ù
                const careData = data.careByClass5[product.class5] || { qtyA: 0, qtyB: 0, amtA: 0, amtB: 0 };
                const careQtyA = careData.qtyA;  // A = ÂéªÂπ¥
                const careQtyB = careData.qtyB;  // B = ‰ªäÂπ¥
                const careAmtA = careData.amtA;
                const careAmtB = careData.amtB;

                // Á¥ØÂä†Âà∞ÊÄªËÆ°
                totalCareQtyA += careQtyA;
                totalCareQtyB += careQtyB;
                totalCareAmtA += careAmtA;
                totalCareAmtB += careAmtB;

                // ‰∏ªÊú∫Êï∞Èáè
                const mainQtyA = data.categories[product.mainCategory].qtyA;  // ÂéªÂπ¥
                const mainQtyB = data.categories[product.mainCategory].qtyB;  // ‰ªäÂπ¥

                // Á¥ØÂä†‰∏ªÊú∫Êï∞ÈáèÂà∞ÊÄªËÆ°ÔºàÊéíÈô§ CareÔºâ
                if (product.mainCategory !== 'Care') {
                    totalMainQtyA += mainQtyA;
                    totalMainQtyB += mainQtyB;
                }

                // Êê≠ÂîÆÁéá
                const rateA = mainQtyA > 0 ? (careQtyA / mainQtyA * 100) : 0;  // ÂéªÂπ¥
                const rateB = mainQtyB > 0 ? (careQtyB / mainQtyB * 100) : 0;  // ‰ªäÂπ¥
                const rateDiff = rateB - rateA;

                // ÊàêÈïøÁéá = (‰ªäÂπ¥ - ÂéªÂπ¥) / ÂéªÂπ¥ * 100
                const qtyGrowth = careQtyA !== 0 ? ((careQtyB - careQtyA) / careQtyA * 100).toFixed(1) : 0;
                const amtGrowth = careAmtA !== 0 ? ((careAmtB - careAmtA) / careAmtA * 100).toFixed(1) : 0;

                const qtyClass = qtyGrowth > 0 ? 'positive' : qtyGrowth < 0 ? 'negative' : 'neutral';
                const amtClass = amtGrowth > 0 ? 'positive' : amtGrowth < 0 ? 'negative' : 'neutral';
                const rateClass = rateDiff > 0 ? 'positive' : rateDiff < 0 ? 'negative' : 'neutral';
                const qtySign = qtyGrowth > 0 ? '+' : '';
                const amtSign = amtGrowth > 0 ? '+' : '';
                const rateSign = rateDiff > 0 ? '+' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="store-name">${product.name}</td>
                    <td>${Math.round(careQtyA).toLocaleString()}</td>
                    <td>${Math.round(careQtyB).toLocaleString()}</td>
                    <td><span class="growth ${qtyClass}">${qtySign}${qtyGrowth}%</span></td>
                    <td>${Math.round(careAmtA).toLocaleString()}</td>
                    <td>${Math.round(careAmtB).toLocaleString()}</td>
                    <td><span class="growth ${amtClass}">${amtSign}${amtGrowth}%</span></td>
                    <td class="rate-value" style="color: #fb923c;">${rateA.toFixed(2)}%</td>
                    <td class="rate-value" style="color: #4ade80;">${rateB.toFixed(2)}%</td>
                    <td><span class="growth ${rateClass}">${rateSign}${rateDiff.toFixed(2)}%</span></td>
                `;
                tbody.appendChild(row);
            });

            // Âä†ÂÖ•ÊÄªËÆ°Âàó
            const totalQtyGrowth = totalCareQtyA !== 0 ? ((totalCareQtyB - totalCareQtyA) / totalCareQtyA * 100) : 0;
            const totalAmtGrowth = totalCareAmtA !== 0 ? ((totalCareAmtB - totalCareAmtA) / totalCareAmtA * 100) : 0;
            const totalRateA = totalMainQtyA > 0 ? (totalCareQtyA / totalMainQtyA * 100) : 0;
            const totalRateB = totalMainQtyB > 0 ? (totalCareQtyB / totalMainQtyB * 100) : 0;
            const totalRateDiff = totalRateB - totalRateA;

            const totalQtyClass = totalQtyGrowth > 0 ? 'positive' : totalQtyGrowth < 0 ? 'negative' : 'neutral';
            const totalAmtClass = totalAmtGrowth > 0 ? 'positive' : totalAmtGrowth < 0 ? 'negative' : 'neutral';
            const totalRateClass = totalRateDiff > 0 ? 'positive' : totalRateDiff < 0 ? 'negative' : 'neutral';
            const totalQtySign = totalQtyGrowth > 0 ? '+' : '';
            const totalAmtSign = totalAmtGrowth > 0 ? '+' : '';
            const totalRateSign = totalRateDiff > 0 ? '+' : '';

            const totalRow = document.createElement('tr');
            totalRow.style.background = 'rgba(255, 255, 255, 0.08)';
            totalRow.style.fontWeight = '600';
            totalRow.innerHTML = `
                <td class="store-name">ÊÄªËÆ°</td>
                <td>${Math.round(totalCareQtyA).toLocaleString()}</td>
                <td>${Math.round(totalCareQtyB).toLocaleString()}</td>
                <td><span class="growth ${totalQtyClass}">${totalQtySign}${totalQtyGrowth.toFixed(1)}%</span></td>
                <td>${Math.round(totalCareAmtA).toLocaleString()}</td>
                <td>${Math.round(totalCareAmtB).toLocaleString()}</td>
                <td><span class="growth ${totalAmtClass}">${totalAmtSign}${totalAmtGrowth.toFixed(1)}%</span></td>
                <td class="rate-value" style="color: #fb923c;">${totalRateA.toFixed(2)}%</td>
                <td class="rate-value" style="color: #4ade80;">${totalRateB.toFixed(2)}%</td>
                <td><span class="growth ${totalRateClass}">${totalRateSign}${totalRateDiff.toFixed(2)}%</span></td>
            `;
            tbody.appendChild(totalRow);
        }

        function formatGrowth(value) {
            const sign = value > 0 ? '+' : '';
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            return `<span class="growth ${className}">${sign}${value.toFixed(2)}%</span>`;
        }

        function formatDifference(value) {
            const sign = value > 0 ? '+' : '';
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            return `<span class="growth ${className}">${sign}${value.toFixed(2)}%</span>`;
        }

        function exportToCSV() {
            if (!currentStore || !allStoresData[currentStore]) {
                alert('Ë´ãÂÖàÈÄ≤Ë°åÂàÜÊûê');
                return;
            }

            const data = allStoresData[currentStore];
            const storeDisplay = `ÈñÄÂ∏Ç${currentStore}`;
            let csv = '\uFEFF';
            
            // Ê®ôÈ°å
            csv += `${storeDisplay}\n\n`;
            
            // Á¨¨‰∏ÄÈÉ®ÂàÜÔºöÈä∑ÂîÆÂàÜÊûêÁµêÊûúËàáÂπ¥Â∫¶Â∞çÊØî
            csv += 'Èä∑ÂîÆÂàÜÊûêÁµêÊûúËàáÂπ¥Â∫¶Â∞çÊØî\n';
            csv += 'ÂìÅÈ†Ö,ÂéªÂπ¥Êï∏Èáè,‰ªäÂπ¥Êï∏Èáè,Êï∏ÈáèÊàêÈï∑Áéá,ÂéªÂπ¥ÈáëÈ°ç,‰ªäÂπ¥ÈáëÈ°ç,ÈáëÈ°çÊàêÈï∑Áéá,ÂéªÂπ¥ÊØõÂà©,‰ªäÂπ¥ÊØõÂà©,ÊØõÂà©ÊàêÈï∑Áéá,ÂéªÂπ¥ÊØõÂà©Áéá,‰ªäÂπ¥ÊØõÂà©Áéá,ÊØõÂà©ÁéáÂ∑ÆÁï∞\n';
            
            targetCategories.forEach(category => {
                const stats = data.categories[category];
                const profitA = stats.amtA - stats.costA;
                const profitB = stats.amtB - stats.costB;
                const profitRateA = stats.amtA > 0 ? (profitA / stats.amtA * 100) : 0;
                const profitRateB = stats.amtB > 0 ? (profitB / stats.amtB * 100) : 0;
                
                csv += `${category},${Math.round(stats.qtyA)},${Math.round(stats.qtyB)},`;
                csv += `${stats.qtyA !== 0 ? ((stats.qtyB - stats.qtyA) / stats.qtyA * 100).toFixed(2) : 0}%,`;
                csv += `${Math.round(stats.amtA)},${Math.round(stats.amtB)},`;
                csv += `${stats.amtA !== 0 ? ((stats.amtB - stats.amtA) / stats.amtA * 100).toFixed(2) : 0}%,`;
                csv += `${Math.round(profitA)},${Math.round(profitB)},`;
                csv += `${profitA !== 0 ? ((profitB - profitA) / profitA * 100).toFixed(2) : 0}%,`;
                csv += `${profitRateA.toFixed(2)}%,${profitRateB.toFixed(2)}%,`;
                csv += `${(profitRateB - profitRateA).toFixed(2)}%\n`;
            });

            // Á¨¨‰∫åÈÉ®ÂàÜÔºöCare ‰∫ßÂìÅÊê≠ÂîÆÁéáÂàÜÊûê
            csv += '\n\nCare ‰∫ßÂìÅÊê≠ÂîÆÁéáÂàÜÊûê\n';
            csv += '‰∫ßÂìÅÁ±ªÂà´,ÂéªÂπ¥Êï∞Èáè,‰ªäÂπ¥Êï∞Èáè,Êï∞ÈáèÊàêÈïøÁéá,ÂéªÂπ¥ÈáëÈ¢ù,‰ªäÂπ¥ÈáëÈ¢ù,ÈáëÈ¢ùÊàêÈïøÁéá,ÂéªÂπ¥Êê≠ÂîÆÁéá,‰ªäÂπ¥Êê≠ÂîÆÁéá,Êê≠ÂîÆÁéáÂ∑ÆÂºÇ\n';
            
            const careProducts = [
                { name: 'CPU', class5: 'CPU', mainCategory: 'CPU' },
                { name: 'iPad', class5: 'iPad', mainCategory: 'iPad' },
                { name: 'iPhone', class5: 'iPhone', mainCategory: 'iPhone' },
                { name: 'Apple Watch', class5: 'AW', mainCategory: 'Apple Watch' },
                { name: 'AirPods', class5: 'Audio', mainCategory: 'AirPods' }  // Audio class5 ‚Üí ÊòæÁ§∫‰∏∫ AirPods
            ];

            // ÊÄªËÆ°ÂèòÊï∞
            let totalCareQtyA = 0, totalCareQtyB = 0, totalCareAmtA = 0, totalCareAmtB = 0;
            let totalMainQtyA = 0, totalMainQtyB = 0;

            careProducts.forEach(product => {
                const careData = data.careByClass5[product.class5] || { qtyA: 0, qtyB: 0, amtA: 0, amtB: 0 };
                const careQtyA = careData.qtyA;  // ÂéªÂπ¥
                const careQtyB = careData.qtyB;  // ‰ªäÂπ¥
                const careAmtA = careData.amtA;
                const careAmtB = careData.amtB;

                // Á¥ØÂä†Âà∞ÊÄªËÆ°
                totalCareQtyA += careQtyA;
                totalCareQtyB += careQtyB;
                totalCareAmtA += careAmtA;
                totalCareAmtB += careAmtB;

                // ‰∏ªÊú∫Êï∞Èáè
                const mainQtyA = data.categories[product.mainCategory].qtyA;  // ÂéªÂπ¥
                const mainQtyB = data.categories[product.mainCategory].qtyB;  // ‰ªäÂπ¥

                // Á¥ØÂä†‰∏ªÊú∫Êï∞Èáè
                if (product.mainCategory !== 'Care') {
                    totalMainQtyA += mainQtyA;
                    totalMainQtyB += mainQtyB;
                }

                // Êê≠ÂîÆÁéá
                const rateA = mainQtyA > 0 ? (careQtyA / mainQtyA * 100) : 0;
                const rateB = mainQtyB > 0 ? (careQtyB / mainQtyB * 100) : 0;
                const rateDiff = rateB - rateA;

                // ÊàêÈïøÁéá
                const qtyGrowth = careQtyA !== 0 ? ((careQtyB - careQtyA) / careQtyA * 100) : 0;
                const amtGrowth = careAmtA !== 0 ? ((careAmtB - careAmtA) / careAmtA * 100) : 0;

                csv += `${product.name},`;
                csv += `${Math.round(careQtyA)},${Math.round(careQtyB)},`;
                csv += `${qtyGrowth.toFixed(2)}%,`;
                csv += `${Math.round(careAmtA)},${Math.round(careAmtB)},`;
                csv += `${amtGrowth.toFixed(2)}%,`;
                csv += `${rateA.toFixed(2)}%,${rateB.toFixed(2)}%,`;
                csv += `${rateDiff.toFixed(2)}%\n`;
            });

            // Âä†ÂÖ•ÊÄªËÆ°Âàó
            const totalQtyGrowth = totalCareQtyA !== 0 ? ((totalCareQtyB - totalCareQtyA) / totalCareQtyA * 100) : 0;
            const totalAmtGrowth = totalCareAmtA !== 0 ? ((totalCareAmtB - totalCareAmtA) / totalCareAmtA * 100) : 0;
            const totalRateA = totalMainQtyA > 0 ? (totalCareQtyA / totalMainQtyA * 100) : 0;
            const totalRateB = totalMainQtyB > 0 ? (totalCareQtyB / totalMainQtyB * 100) : 0;
            const totalRateDiff = totalRateB - totalRateA;

            csv += `ÊÄªËÆ°,`;
            csv += `${Math.round(totalCareQtyA)},${Math.round(totalCareQtyB)},`;
            csv += `${totalQtyGrowth.toFixed(2)}%,`;
            csv += `${Math.round(totalCareAmtA)},${Math.round(totalCareAmtB)},`;
            csv += `${totalAmtGrowth.toFixed(2)}%,`;
            csv += `${totalRateA.toFixed(2)}%,${totalRateB.toFixed(2)}%,`;
            csv += `${totalRateDiff.toFixed(2)}%\n`;

            // ‰∫ßÁîü‰∏ãËΩΩ
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `store_report_${currentStore}_${today}.csv`);
            link.click();
        }
    </script>
</body>
</html>

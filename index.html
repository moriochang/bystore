<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iStore é–€å¸‚éŠ·å”®å ±è¡¨åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .excel-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #21A366 0%, #107C41 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(33, 163, 102, 0.3);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #ffffff;
            flex: 1;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-input-group {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .file-input-group:hover {
            border-color: rgba(0, 122, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .file-input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #b0b0b0;
        }

        .file-input-group.file-a label {
            color: #4ade80;
        }

        .file-input-group.file-b label {
            color: #fb923c;
        }

        .file-input-group.file-ref label {
            color: #60a5fa;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            font-weight: 500;
        }

        input[type="file"]::file-selector-button:hover {
            background: #0066dd;
        }

        .analyze-btn {
            width: 100%;
            padding: 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analyze-btn:hover:not(:disabled) {
            background: #0066dd;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
        }

        .analyze-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .store-selector {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: none;
        }

        .store-selector.active {
            display: block;
        }

        .store-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .store-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .store-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .store-btn.active {
            background: #007aff;
            border-color: #007aff;
            color: white;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .summary-label {
            font-size: 13px;
            color: #b0b0b0;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .summary-subvalue {
            font-size: 14px;
            color: #9ca3af;
        }

        .care-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .care-table thead {
            background: rgba(255, 255, 255, 0.05);
        }

        .care-table th,
        .care-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* éŠ·å”®åˆ†æçµæœè¡¨æ ¼çš„å‚ç›´åˆ†éš”ç·š - åªåœ¨æ•¸æ“šè¡Œé¡¯ç¤ºï¼Œæ¨™é¡Œè¡Œä¸é¡¯ç¤º */
        .sales-analysis-table tbody td:nth-child(1) {
            border-right: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .sales-analysis-table tbody td:nth-child(4),
        .sales-analysis-table tbody td:nth-child(7),
        .sales-analysis-table tbody td:nth-child(10) {
            border-right: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Care ç”¢å“æ­å”®ç‡åˆ†æè¡¨æ ¼çš„å‚ç›´åˆ†éš”ç·š - åªåœ¨æ•¸æ“šè¡Œé¡¯ç¤ºï¼Œæ¨™é¡Œè¡Œä¸é¡¯ç¤º */
        .care-attach-table tbody td:nth-child(1) {
            border-right: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .care-attach-table tbody td:nth-child(5),
        .care-attach-table tbody td:nth-child(9) {
            border-right: 2px solid rgba(255, 255, 255, 0.3);
        }

        .care-table th {
            color: #b0b0b0;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .care-table td {
            color: #e0e0e0;
            font-size: 15px;
        }

        .care-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .care-table .store-name {
            font-weight: 600;
            color: #ffffff;
        }

        .care-table .rate-value {
            font-weight: 600;
            font-size: 16px;
        }

        .growth {
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
        }

        .growth.positive {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .growth.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .growth.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .export-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .export-btn {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 22px;
            }

            .section-title {
                font-size: 20px;
            }

            .care-table {
                font-size: 14px;
            }

            .care-table th,
            .care-table td {
                padding: 12px 8px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <div class="excel-icon">ğŸ“Š</div>
                <h1>iStore é–€å¸‚éŠ·å”®å ±è¡¨åˆ†æ</h1>
            </div>
            
            <div class="upload-grid">
                <div class="file-input-group file-a">
                    <label>ğŸ“ å°æ¯”Aæª”æ¡ˆ (å»å¹´)</label>
                    <input type="file" id="fileA" accept=".xlsx,.xls">
                </div>
                <div class="file-input-group file-b">
                    <label>ğŸ“ å°æ¯”Bæª”æ¡ˆ (ä»Šå¹´)</label>
                    <input type="file" id="fileB" accept=".xlsx,.xls">
                </div>
            </div>
            
            <button class="analyze-btn" id="analyzeBtn" disabled>é–‹å§‹åˆ†æ</button>
        </header>

        <div class="store-selector" id="storeSelector">
            <div class="section-title">ğŸª é¸æ“‡é–€å¸‚</div>
            <div class="store-buttons" id="storeButtons"></div>
        </div>

        <div class="results" id="results">
            <!-- 1. éŠ·å”®åˆ†æçµæœèˆ‡å¹´åº¦å°æ¯” -->
            <div class="section">
                <div class="section-title">
                    <span>ğŸ¯</span>
                    <span>éŠ·å”®åˆ†æçµæœèˆ‡å¹´åº¦å°æ¯”</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="care-table sales-analysis-table" id="categoryComparisonTable">
                        <thead>
                            <tr>
                                <th rowspan="2" style="vertical-align: middle;">å“é …</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">éŠ·å”®æ•¸é‡</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">éŠ·å”®é‡‘é¡</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">æ¯›åˆ©é¡</th>
                                <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">æ¯›åˆ©ç‡</th>
                            </tr>
                            <tr>
                                <th>å»å¹´</th>
                                <th>ä»Šå¹´</th>
                                <th>æˆé•·ç‡</th>
                                <th>å»å¹´</th>
                                <th>ä»Šå¹´</th>
                                <th>æˆé•·ç‡</th>
                                <th>å»å¹´</th>
                                <th>ä»Šå¹´</th>
                                <th>æˆé•·ç‡</th>
                                <th>å»å¹´</th>
                                <th>ä»Šå¹´</th>
                                <th>å·®ç•°</th>
                            </tr>
                        </thead>
                        <tbody id="categoryComparisonBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 2. ç¸½è¨ˆæ‘˜è¦ -->
            <div class="section">
                <div class="section-title">
                    <span>ğŸ“ˆ</span>
                    <span>ç¸½è¨ˆæ‘˜è¦</span>
                </div>
                <div class="summary-grid" id="summaryGrid"></div>
            </div>

            <!-- 3. Care ç”¢å“æ­å”®ç‡åˆ†æ -->
            <div class="section">
                <div class="section-title">
                    <span>ğŸ›¡ï¸</span>
                    <span>Care ç”¢å“æ­å”®ç‡åˆ†æ</span>
                </div>
                <p style="color: #b0b0b0; margin-bottom: 20px; font-size: 14px;">
                    â€» æ­å”®ç‡ = (ACPP+ + iCPP) / ä¸»æ©ŸéŠ·å”®æ•¸é‡ Ã— 100%
                </p>
                <table class="care-table care-attach-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="vertical-align: middle;">ç”¢å“é¡åˆ¥</th>
                            <th colspan="4" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">å»å¹´</th>
                            <th colspan="4" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">ä»Šå¹´</th>
                            <th colspan="4" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">YoY</th>
                        </tr>
                        <tr>
                            <th>ST</th>
                            <th>AC+ å¥—æ•¸</th>
                            <th>AC+ é‡‘é¡</th>
                            <th>æ­å”®ç‡</th>
                            <th>ST</th>
                            <th>AC+ å¥—æ•¸</th>
                            <th>AC+ é‡‘é¡</th>
                            <th>æ­å”®ç‡</th>
                            <th>ST</th>
                            <th>AC+ å¥—æ•¸</th>
                            <th>AC+ é‡‘é¡</th>
                            <th>æ­å”®ç‡</th>
                        </tr>
                    </thead>
                    <tbody id="careTableBody"></tbody>
                </table>
            </div>

            <!-- åŒ¯å‡ºåŠŸèƒ½ -->
            <div class="export-section">
                <button class="export-btn" onclick="exportToCSV()">ğŸ“¥ åŒ¯å‡º CSV</button>
            </div>
        </div>
    </div>

    <script>
        let fileAData = null;
        let fileBData = null;
        let referenceData = null;
        let allStoresData = {};
        let currentStore = '75';  // é è¨­é¡¯ç¤ºé–€å¸‚ 75

        const fileAInput = document.getElementById('fileA');
        const fileBInput = document.getElementById('fileB');
        const analyzeBtn = document.getElementById('analyzeBtn');

        const targetCategories = ['CPU', 'iPad', 'iPhone', 'Apple Watch', 'AirPods', 'Audio', 'Care', 'Accy', '3rd Party'];

        fileAInput.addEventListener('change', checkFiles);
        fileBInput.addEventListener('change', checkFiles);
        analyzeBtn.addEventListener('click', analyzeData);

        function checkFiles() {
            analyzeBtn.disabled = !(fileAInput.files.length > 0 && fileBInput.files.length > 0);
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function analyzeData() {
            try {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'åˆ†æä¸­...';

                // è‡ªå‹•è¼‰å…¥åƒç…§è³‡æ–™
                console.log('é–‹å§‹è¼‰å…¥åƒç…§è³‡æ–™...');
                const refResponse = await fetch('data/lizan_reference.xlsx');
                
                if (!refResponse.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥åƒç…§è³‡æ–™: ${refResponse.status} ${refResponse.statusText}`);
                }
                
                const refArrayBuffer = await refResponse.arrayBuffer();
                const refData = new Uint8Array(refArrayBuffer);
                const wbRef = XLSX.read(refData, { type: 'array' });
                console.log('åƒç…§è³‡æ–™è¼‰å…¥æˆåŠŸ');

                // è®€å–å…©å€‹ä¸Šå‚³çš„æª”æ¡ˆ
                console.log('é–‹å§‹è®€å–ä¸Šå‚³æª”æ¡ˆ...');
                const [wbA, wbB] = await Promise.all([
                    readExcelFile(fileAInput.files[0]),
                    readExcelFile(fileBInput.files[0])
                ]);
                console.log('ä¸Šå‚³æª”æ¡ˆè®€å–æˆåŠŸ');

                // è§£æåƒç…§è³‡æ–™
                console.log('é–‹å§‹è§£æåƒç…§è³‡æ–™...');
                referenceData = parseReferenceData(wbRef);
                console.log('åƒç…§è³‡æ–™è§£æå®Œæˆ');

                // è§£æéŠ·å”®è³‡æ–™
                console.log('é–‹å§‹è§£æéŠ·å”®è³‡æ–™...');
                fileAData = parseSalesData(wbA);
                fileBData = parseSalesData(wbB);
                console.log('éŠ·å”®è³‡æ–™è§£æå®Œæˆ');

                // è™•ç†æ‰€æœ‰é–€å¸‚è³‡æ–™
                console.log('é–‹å§‹è™•ç†é–€å¸‚è³‡æ–™...');
                processAllStores();
                console.log('é–€å¸‚è³‡æ–™è™•ç†å®Œæˆ');

                // é¡¯ç¤ºé–€å¸‚é¸æ“‡å™¨
                displayStoreSelector();

                // é è¨­é¡¯ç¤ºé–€å¸‚ 75
                displayStoreData('75');

                document.getElementById('storeSelector').classList.add('active');
                document.getElementById('results').classList.add('active');
                
                analyzeBtn.textContent = 'é‡æ–°åˆ†æ';
                console.log('åˆ†æå®Œæˆï¼');
            } catch (error) {
                console.error('åˆ†æéŒ¯èª¤:', error);
                console.error('éŒ¯èª¤å †ç–Š:', error.stack);
                alert('æª”æ¡ˆåˆ†æéŒ¯èª¤ï¼š' + error.message + '\n\nè«‹ç¢ºèªï¼š\n1. å·²æ­£ç¢ºä¸Šå‚³å…©å€‹å°æ¯”æª”æ¡ˆ\n2. ç¶²é å¯æ­£å¸¸å­˜å– data/lizan_reference.xlsx\n3. æª”æ¡ˆæ ¼å¼æ­£ç¢º');
                analyzeBtn.textContent = 'é–‹å§‹åˆ†æ';
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        function parseReferenceData(workbook) {
            const reference = {
                products: {},
                care: {}
            };

            // è§£æã€Œç«‹å±•ã€å·¥ä½œè¡¨
            const lizanSheet = workbook.Sheets['ç«‹å±•'];
            if (lizanSheet) {
                const lizanData = XLSX.utils.sheet_to_json(lizanSheet);
                lizanData.forEach(row => {
                    if (row.Code) {
                        reference.products[row.Code] = {
                            å¤§åˆ†é¡: row['å¤§åˆ†é¡'],
                            ä¸­åˆ†é¡: row['ä¸­åˆ†é¡'],
                            å°åˆ†é¡: row['å°åˆ†é¡']
                        };
                    }
                });
            }

            // è§£æã€ŒCareã€å·¥ä½œè¡¨
            const careSheet = workbook.Sheets['Care'];
            if (careSheet) {
                const careData = XLSX.utils.sheet_to_json(careSheet);
                careData.forEach(row => {
                    if (row.Code) {
                        reference.care[row.Code] = {
                            å¤§åˆ†é¡: row['å¤§åˆ†é¡'],
                            ä¸­åˆ†é¡: row['ä¸­åˆ†é¡'],
                            å°åˆ†é¡: row['å°åˆ†é¡'],
                            class5: row.class5  // CPU, iPad, iPhone, AW, AirPods, Audio
                        };
                    }
                });
            }

            return reference;
        }

        function parseSalesData(workbook) {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet);
            
            return data.map(row => ({
                storeCode: row.store_code_id,
                storeName: row.store_name1,
                productCode: row.product_code,
                productName: row.product_name,
                qty: parseFloat(row.total_qty) || 0,
                amt: parseFloat(row.total_amt_t1) || 0,
                cost: parseFloat(row.total_cost) || 0,
                adjCost: parseFloat(row.total_ADJ_COST) || 0
            }));
        }

        function processAllStores() {
            allStoresData = {};
            
            // æ”¶é›†æ‰€æœ‰é–€å¸‚ï¼ˆä½¿ç”¨ store_code_idï¼‰
            const storeMap = new Map();
            fileAData.forEach(row => {
                if (row.storeCode && row.storeName) {
                    storeMap.set(row.storeCode, row.storeName);
                }
            });
            fileBData.forEach(row => {
                if (row.storeCode && row.storeName) {
                    storeMap.set(row.storeCode, row.storeName);
                }
            });

            // è™•ç†æ¯å€‹é–€å¸‚
            storeMap.forEach((storeName, storeCode) => {
                const storeDataA = fileAData.filter(r => r.storeCode === storeCode);
                const storeDataB = fileBData.filter(r => r.storeCode === storeCode);
                
                allStoresData[storeCode] = {
                    ...processStoreData(storeDataA, storeDataB),
                    storeName: storeName,
                    storeCode: storeCode
                };
            });
        }

        function processStoreData(dataA, dataB) {
            const result = {
                categories: {},
                careByClass5: {}
            };

            // åˆå§‹åŒ–å„å¤§åˆ†é¡
            targetCategories.forEach(category => {
                result.categories[category] = {
                    qtyA: 0,  // A = å»å¹´
                    qtyB: 0,  // B = ä»Šå¹´
                    amtA: 0,
                    amtB: 0,
                    costA: 0,
                    costB: 0
                };
            });

            // åˆå§‹åŒ– Care çš„ class5 çµ±è¨ˆ
            const careClass5List = ['CPU', 'iPad', 'iPhone', 'AW', 'AirPods', 'Audio'];
            careClass5List.forEach(class5 => {
                result.careByClass5[class5] = {
                    qtyA: 0,  // A = å»å¹´
                    qtyB: 0,  // B = ä»Šå¹´
                    amtA: 0,
                    amtB: 0
                };
            });

            // æ ¹æ“šç”¢å“åç¨±æ¨æ¸¬ class5ï¼ˆç”¨æ–¼ä¸åœ¨Careå·¥ä½œè¡¨ä¸­çš„ç”¢å“ï¼‰
            function guessClass5FromName(productName) {
                const name = productName.toUpperCase();
                if (name.includes('MBA') || name.includes('MBP') || name.includes('MAC MINI') || 
                    name.includes('IMAC') || name.includes('MAC PRO') || name.includes('MACBOOK')) {
                    return 'CPU';
                }
                if (name.includes('IPAD')) return 'iPad';
                if (name.includes('IPHONE')) return 'iPhone';
                if (name.includes('WATCH') || name.includes(' AW ')) return 'AW';
                if (name.includes('AIRPODS')) return 'AirPods';
                if (name.includes('HOMEPOD') || name.includes('BEATS')) return 'Audio';
                return null;
            }

            // è™•ç†å°æ¯”Aï¼ˆå»å¹´ï¼‰
            dataA.forEach(row => {
                // å…ˆå¾ç«‹å±•å·¥ä½œè¡¨æª¢æŸ¥æ˜¯å¦ç‚ºCareç”¢å“
                const refData = referenceData.products[row.productCode];
                
                if (refData && refData['å¤§åˆ†é¡'] === 'Care') {
                    // æ˜¯ Care ç”¢å“
                    let class5 = null;
                    
                    // å„ªå…ˆå¾Careå·¥ä½œè¡¨å–å¾—class5
                    if (referenceData.care[row.productCode]) {
                        class5 = referenceData.care[row.productCode].class5;
                    } else {
                        // å¦‚æœä¸åœ¨Careå·¥ä½œè¡¨ä¸­ï¼Œæ ¹æ“šç”¢å“åç¨±æ¨æ¸¬
                        class5 = guessClass5FromName(row.productName);
                    }
                    
                    if (class5 && result.careByClass5[class5]) {
                        result.careByClass5[class5].qtyA += row.qty;
                        result.careByClass5[class5].amtA += row.amt;
                    }
                    
                    // Care ä¹Ÿè¦è¨ˆå…¥å¤§åˆ†é¡çµ±è¨ˆ
                    result.categories['Care'].qtyA += row.qty;
                    result.categories['Care'].amtA += row.amt;
                    result.categories['Care'].costA += row.cost;
                    result.categories['Care'].costA -= row.adjCost;
                } else if (refData) {
                    // ä¸æ˜¯ Care ç”¢å“
                    const category = refData['å¤§åˆ†é¡'];
                    
                    if (result.categories[category]) {
                        result.categories[category].qtyA += row.qty;
                        result.categories[category].amtA += row.amt;
                        result.categories[category].costA += row.cost;
                        result.categories[category].costA -= row.adjCost;
                    }
                }
            });

            // è™•ç†å°æ¯”Bï¼ˆä»Šå¹´ï¼‰
            dataB.forEach(row => {
                const refData = referenceData.products[row.productCode];
                
                if (refData && refData['å¤§åˆ†é¡'] === 'Care') {
                    let class5 = null;
                    
                    if (referenceData.care[row.productCode]) {
                        class5 = referenceData.care[row.productCode].class5;
                    } else {
                        class5 = guessClass5FromName(row.productName);
                    }
                    
                    if (class5 && result.careByClass5[class5]) {
                        result.careByClass5[class5].qtyB += row.qty;
                        result.careByClass5[class5].amtB += row.amt;
                    }
                    
                    result.categories['Care'].qtyB += row.qty;
                    result.categories['Care'].amtB += row.amt;
                    result.categories['Care'].costB += row.cost;
                    result.categories['Care'].costB -= row.adjCost;
                } else if (refData) {
                    const category = refData['å¤§åˆ†é¡'];
                    
                    if (result.categories[category]) {
                        result.categories[category].qtyB += row.qty;
                        result.categories[category].amtB += row.amt;
                        result.categories[category].costB += row.cost;
                        result.categories[category].costB -= row.adjCost;
                    }
                }
            });

            return result;
        }

        function displayStoreSelector() {
            const storeButtons = document.getElementById('storeButtons');
            storeButtons.innerHTML = '';

            // åªé¡¯ç¤ºæŒ‡å®šçš„é–€å¸‚ï¼ˆä¸åŒ…å«å…¨ç¤¾ï¼‰
            const targetStores = ['75', '76', '77', '81', '84'];

            targetStores.forEach(storeCode => {
                if (!allStoresData[storeCode]) return;  // å¦‚æœè©²é–€å¸‚æ²’æœ‰è³‡æ–™å‰‡è·³é
                
                const btn = document.createElement('button');
                btn.className = storeCode === '75' ? 'store-btn active' : 'store-btn';  // é è¨­é¸ä¸­é–€å¸‚75
                btn.textContent = storeCode;
                btn.onclick = () => selectStore(storeCode);
                storeButtons.appendChild(btn);
            });
        }

        function selectStore(storeCode) {
            currentStore = storeCode;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.store-btn').forEach(btn => {
                const btnCode = btn.textContent.split(' ')[0];
                btn.classList.toggle('active', btnCode === storeCode);
            });

            displayStoreData(storeCode);
        }

        function displayStoreData(storeCode) {
            const data = allStoresData[storeCode];
            if (!data) return;

            displayCategoryComparison(data);
            displaySummary(data);
            displayCareAnalysis(data);
        }

        function displayCategoryComparison(data) {
            const tbody = document.getElementById('categoryComparisonBody');
            tbody.innerHTML = '';

            // è¨ˆç®—ç¸½è¨ˆï¼ˆæ’é™¤ Careï¼‰
            let totalQtyA = 0, totalQtyB = 0, totalAmtA = 0, totalAmtB = 0;
            let totalProfitA = 0, totalProfitB = 0;
            
            targetCategories.forEach(category => {
                if (category === 'Care') return;
                
                const stats = data.categories[category];
                totalQtyA += stats.qtyA;  // A = å»å¹´
                totalQtyB += stats.qtyB;  // B = ä»Šå¹´
                totalAmtA += stats.amtA;
                totalAmtB += stats.amtB;
                totalProfitA += (stats.amtA - stats.costA);
                totalProfitB += (stats.amtB - stats.costB);
            });

            // é¡¯ç¤ºå„åˆ†é¡
            targetCategories.forEach(category => {
                const stats = data.categories[category];
                
                // æˆé•·ç‡ = (ä»Šå¹´ - å»å¹´) / å»å¹´ * 100
                const qtyGrowth = stats.qtyA !== 0 ? ((stats.qtyB - stats.qtyA) / stats.qtyA * 100) : 0;
                const amtGrowth = stats.amtA !== 0 ? ((stats.amtB - stats.amtA) / stats.amtA * 100) : 0;
                const profitA = stats.amtA - stats.costA;  // å»å¹´æ¯›åˆ©
                const profitB = stats.amtB - stats.costB;  // ä»Šå¹´æ¯›åˆ©
                const profitGrowth = profitA !== 0 ? ((profitB - profitA) / profitA * 100) : 0;
                const profitRateA = stats.amtA > 0 ? (profitA / stats.amtA * 100) : 0;  // å»å¹´æ¯›åˆ©ç‡
                const profitRateB = stats.amtB > 0 ? (profitB / stats.amtB * 100) : 0;  // ä»Šå¹´æ¯›åˆ©ç‡
                const profitRateDiff = profitRateB - profitRateA;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="store-name">${category}</td>
                    <td>${Math.round(stats.qtyA).toLocaleString()}</td>
                    <td>${Math.round(stats.qtyB).toLocaleString()}</td>
                    <td>${formatGrowth(qtyGrowth)}</td>
                    <td>${Math.round(stats.amtA).toLocaleString()}</td>
                    <td>${Math.round(stats.amtB).toLocaleString()}</td>
                    <td>${formatGrowth(amtGrowth)}</td>
                    <td>${Math.round(profitA).toLocaleString()}</td>
                    <td>${Math.round(profitB).toLocaleString()}</td>
                    <td>${formatGrowth(profitGrowth)}</td>
                    <td>${profitRateA.toFixed(2)}%</td>
                    <td>${profitRateB.toFixed(2)}%</td>
                    <td>${formatDifference(profitRateDiff)}</td>
                `;
                tbody.appendChild(row);
            });

            // åŠ å…¥ç¸½è¨ˆåˆ—
            const totalQtyGrowth = totalQtyA !== 0 ? ((totalQtyB - totalQtyA) / totalQtyA * 100) : 0;
            const totalAmtGrowth = totalAmtA !== 0 ? ((totalAmtB - totalAmtA) / totalAmtA * 100) : 0;
            const totalProfitGrowth = totalProfitA !== 0 ? ((totalProfitB - totalProfitA) / totalProfitA * 100) : 0;
            const totalProfitRateA = totalAmtA > 0 ? (totalProfitA / totalAmtA * 100) : 0;
            const totalProfitRateB = totalAmtB > 0 ? (totalProfitB / totalAmtB * 100) : 0;
            const totalProfitRateDiff = totalProfitRateB - totalProfitRateA;

            const totalRow = document.createElement('tr');
            totalRow.style.background = 'rgba(255, 255, 255, 0.08)';
            totalRow.style.fontWeight = '600';
            totalRow.innerHTML = `
                <td class="store-name">ç¸½è¨ˆ (æ’é™¤Care)</td>
                <td>${Math.round(totalQtyA).toLocaleString()}</td>
                <td>${Math.round(totalQtyB).toLocaleString()}</td>
                <td>${formatGrowth(totalQtyGrowth)}</td>
                <td>${Math.round(totalAmtA).toLocaleString()}</td>
                <td>${Math.round(totalAmtB).toLocaleString()}</td>
                <td>${formatGrowth(totalAmtGrowth)}</td>
                <td>${Math.round(totalProfitA).toLocaleString()}</td>
                <td>${Math.round(totalProfitB).toLocaleString()}</td>
                <td>${formatGrowth(totalProfitGrowth)}</td>
                <td>${totalProfitRateA.toFixed(2)}%</td>
                <td>${totalProfitRateB.toFixed(2)}%</td>
                <td>${formatDifference(totalProfitRateDiff)}</td>
            `;
            tbody.appendChild(totalRow);
        }

        function displaySummary(data) {
            const container = document.getElementById('summaryGrid');
            
            // è¨ˆç®—ç¸½è¨ˆï¼ˆæ’é™¤ Careï¼‰
            let totalAmtA = 0, totalAmtB = 0, totalCostA = 0, totalCostB = 0;
            
            targetCategories.forEach(category => {
                if (category === 'Care') return;
                const stats = data.categories[category];
                totalAmtA += stats.amtA;  // A = å»å¹´
                totalAmtB += stats.amtB;  // B = ä»Šå¹´
                totalCostA += stats.costA;
                totalCostB += stats.costB;
            });
            
            const profitA = totalAmtA - totalCostA;  // å»å¹´æ¯›åˆ©
            const profitB = totalAmtB - totalCostB;  // ä»Šå¹´æ¯›åˆ©
            const profitGrowth = profitA !== 0 ? ((profitB - profitA) / profitA * 100).toFixed(1) : 0;
            const profitGrowthClass = profitGrowth > 0 ? 'positive' : profitGrowth < 0 ? 'negative' : 'neutral';
            const profitSign = profitGrowth > 0 ? '+' : '';

            container.innerHTML = `
                <div class="summary-card">
                    <div class="summary-label">å»å¹´éŠ·å”®é¡</div>
                    <div class="summary-value" style="color: #fb923c;">
                        ${(totalAmtA / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})}K
                    </div>
                    <div class="summary-subvalue">å°æ¯”A</div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">ä»Šå¹´éŠ·å”®é¡</div>
                    <div class="summary-value" style="color: #4ade80;">
                        ${(totalAmtB / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})}K
                    </div>
                    <div class="summary-subvalue">å°æ¯”B</div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">ä»Šå¹´æ¯›åˆ©</div>
                    <div class="summary-value" style="color: #60a5fa;">
                        ${(profitB / 1000).toLocaleString(undefined, {maximumFractionDigits: 0})}K
                    </div>
                    <div class="summary-subvalue">æ¯›åˆ©ç‡ ${totalAmtB > 0 ? (profitB / totalAmtB * 100).toFixed(1) : 0}%</div>
                </div>

                <div class="summary-card">
                    <div class="summary-label">æ¯›åˆ©æˆé•·</div>
                    <div class="summary-value">
                        <span class="growth ${profitGrowthClass}">${profitSign}${profitGrowth}%</span>
                    </div>
                    <div class="summary-subvalue">å¹´åº¦å°æ¯”</div>
                </div>
            `;
        }

        function displayCareAnalysis(data) {
            const tbody = document.getElementById('careTableBody');
            tbody.innerHTML = '';

            // Care äº§å“å¯¹åº” - æ³¨æ„ï¼šAudio class5 åŒ…å«æ‰€æœ‰éŸ³é¢‘äº§å“ï¼ˆAirPods, HomePodç­‰ï¼‰
            const careProducts = [
                { name: 'CPU', class5: 'CPU', mainCategory: 'CPU' },
                { name: 'iPad', class5: 'iPad', mainCategory: 'iPad' },
                { name: 'iPhone', class5: 'iPhone', mainCategory: 'iPhone' },
                { name: 'AW', class5: 'AW', mainCategory: 'Apple Watch' },
                { name: 'AirPods', class5: 'Audio', mainCategory: 'AirPods' }  // Audio class5 â†’ æ˜¾ç¤ºä¸º AirPods
            ];

            // ç¸½è¨ˆè®Šæ•¸
            let totalCareQtyA = 0, totalCareQtyB = 0, totalCareAmtA = 0, totalCareAmtB = 0;
            let totalMainQtyA = 0, totalMainQtyB = 0;

            careProducts.forEach(product => {
                // å¾ careByClass5 å–å¾— Care æ•¸é‡å’Œé‡‘é¡
                const careData = data.careByClass5[product.class5] || { qtyA: 0, qtyB: 0, amtA: 0, amtB: 0 };
                const careQtyA = careData.qtyA;  // A = å»å¹´
                const careQtyB = careData.qtyB;  // B = ä»Šå¹´
                const careAmtA = careData.amtA;
                const careAmtB = careData.amtB;

                // ç´¯åŠ åˆ°ç¸½è¨ˆ
                totalCareQtyA += careQtyA;
                totalCareQtyB += careQtyB;
                totalCareAmtA += careAmtA;
                totalCareAmtB += careAmtB;

                // ä¸»æ©Ÿæ•¸é‡ï¼ˆSTï¼‰
                const mainQtyA = data.categories[product.mainCategory].qtyA;  // å»å¹´
                const mainQtyB = data.categories[product.mainCategory].qtyB;  // ä»Šå¹´

                // ç´¯åŠ ä¸»æ©Ÿæ•¸é‡åˆ°ç¸½è¨ˆï¼ˆæ’é™¤ Careï¼‰
                if (product.mainCategory !== 'Care') {
                    totalMainQtyA += mainQtyA;
                    totalMainQtyB += mainQtyB;
                }

                // æ­å”®ç‡
                const rateA = mainQtyA > 0 ? (careQtyA / mainQtyA * 100) : 0;  // å»å¹´
                const rateB = mainQtyB > 0 ? (careQtyB / mainQtyB * 100) : 0;  // ä»Šå¹´
                const rateDiff = rateB - rateA;

                // YoY æˆé•· = (ä»Šå¹´ - å»å¹´) / å»å¹´ * 100
                const stGrowth = mainQtyA !== 0 ? ((mainQtyB - mainQtyA) / mainQtyA * 100) : 0;
                const qtyGrowth = careQtyA !== 0 ? ((careQtyB - careQtyA) / careQtyA * 100) : 0;
                const amtGrowth = careAmtA !== 0 ? ((careAmtB - careAmtA) / careAmtA * 100) : 0;

                const stClass = stGrowth > 0 ? 'positive' : stGrowth < 0 ? 'negative' : 'neutral';
                const qtyClass = qtyGrowth > 0 ? 'positive' : qtyGrowth < 0 ? 'negative' : 'neutral';
                const amtClass = amtGrowth > 0 ? 'positive' : amtGrowth < 0 ? 'negative' : 'neutral';
                const rateClass = rateDiff > 0 ? 'positive' : rateDiff < 0 ? 'negative' : 'neutral';
                
                const stSign = stGrowth > 0 ? '+' : '';
                const qtySign = qtyGrowth > 0 ? '+' : '';
                const amtSign = amtGrowth > 0 ? '+' : '';
                const rateSign = rateDiff > 0 ? '+' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="store-name">${product.name}</td>
                    <td>${Math.round(mainQtyA).toLocaleString()}</td>
                    <td>${Math.round(careQtyA).toLocaleString()}</td>
                    <td>${Math.round(careAmtA).toLocaleString()}</td>
                    <td class="rate-value" style="color: #fb923c;">${rateA.toFixed(2)}%</td>
                    <td>${Math.round(mainQtyB).toLocaleString()}</td>
                    <td>${Math.round(careQtyB).toLocaleString()}</td>
                    <td>${Math.round(careAmtB).toLocaleString()}</td>
                    <td class="rate-value" style="color: #4ade80;">${rateB.toFixed(2)}%</td>
                    <td><span class="growth ${stClass}">${stSign}${stGrowth.toFixed(1)}%</span></td>
                    <td><span class="growth ${qtyClass}">${qtySign}${qtyGrowth.toFixed(1)}%</span></td>
                    <td><span class="growth ${amtClass}">${amtSign}${amtGrowth.toFixed(1)}%</span></td>
                    <td><span class="growth ${rateClass}">${rateSign}${rateDiff.toFixed(2)}%</span></td>
                `;
                tbody.appendChild(row);
            });

            // åŠ å…¥ç¸½è¨ˆåˆ—
            const totalStGrowth = totalMainQtyA !== 0 ? ((totalMainQtyB - totalMainQtyA) / totalMainQtyA * 100) : 0;
            const totalQtyGrowth = totalCareQtyA !== 0 ? ((totalCareQtyB - totalCareQtyA) / totalCareQtyA * 100) : 0;
            const totalAmtGrowth = totalCareAmtA !== 0 ? ((totalCareAmtB - totalCareAmtA) / totalCareAmtA * 100) : 0;
            const totalRateA = totalMainQtyA > 0 ? (totalCareQtyA / totalMainQtyA * 100) : 0;
            const totalRateB = totalMainQtyB > 0 ? (totalCareQtyB / totalMainQtyB * 100) : 0;
            const totalRateDiff = totalRateB - totalRateA;

            const totalStClass = totalStGrowth > 0 ? 'positive' : totalStGrowth < 0 ? 'negative' : 'neutral';
            const totalQtyClass = totalQtyGrowth > 0 ? 'positive' : totalQtyGrowth < 0 ? 'negative' : 'neutral';
            const totalAmtClass = totalAmtGrowth > 0 ? 'positive' : totalAmtGrowth < 0 ? 'negative' : 'neutral';
            const totalRateClass = totalRateDiff > 0 ? 'positive' : totalRateDiff < 0 ? 'negative' : 'neutral';
            
            const totalStSign = totalStGrowth > 0 ? '+' : '';
            const totalQtySign = totalQtyGrowth > 0 ? '+' : '';
            const totalAmtSign = totalAmtGrowth > 0 ? '+' : '';
            const totalRateSign = totalRateDiff > 0 ? '+' : '';

            const totalRow = document.createElement('tr');
            totalRow.style.background = 'rgba(255, 255, 255, 0.08)';
            totalRow.style.fontWeight = '600';
            totalRow.innerHTML = `
                <td class="store-name">ç¸½è¨ˆ</td>
                <td>${Math.round(totalMainQtyA).toLocaleString()}</td>
                <td>${Math.round(totalCareQtyA).toLocaleString()}</td>
                <td>${Math.round(totalCareAmtA).toLocaleString()}</td>
                <td class="rate-value" style="color: #fb923c;">${totalRateA.toFixed(2)}%</td>
                <td>${Math.round(totalMainQtyB).toLocaleString()}</td>
                <td>${Math.round(totalCareQtyB).toLocaleString()}</td>
                <td>${Math.round(totalCareAmtB).toLocaleString()}</td>
                <td class="rate-value" style="color: #4ade80;">${totalRateB.toFixed(2)}%</td>
                <td><span class="growth ${totalStClass}">${totalStSign}${totalStGrowth.toFixed(1)}%</span></td>
                <td><span class="growth ${totalQtyClass}">${totalQtySign}${totalQtyGrowth.toFixed(1)}%</span></td>
                <td><span class="growth ${totalAmtClass}">${totalAmtSign}${totalAmtGrowth.toFixed(1)}%</span></td>
                <td><span class="growth ${totalRateClass}">${totalRateSign}${totalRateDiff.toFixed(2)}%</span></td>
            `;
            tbody.appendChild(totalRow);
        }

        function formatGrowth(value) {
            const sign = value > 0 ? '+' : '';
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            return `<span class="growth ${className}">${sign}${value.toFixed(2)}%</span>`;
        }

        function formatDifference(value) {
            const sign = value > 0 ? '+' : '';
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            return `<span class="growth ${className}">${sign}${value.toFixed(2)}%</span>`;
        }

        function exportToCSV() {
            if (!currentStore || !allStoresData[currentStore]) {
                alert('è«‹å…ˆé€²è¡Œåˆ†æ');
                return;
            }

            const data = allStoresData[currentStore];
            const storeDisplay = `é–€å¸‚${currentStore}`;
            let csv = '\uFEFF';
            
            // æ¨™é¡Œ
            csv += `${storeDisplay}\n\n`;
            
            // ç¬¬ä¸€éƒ¨åˆ†ï¼šéŠ·å”®åˆ†æçµæœèˆ‡å¹´åº¦å°æ¯”
            csv += 'éŠ·å”®åˆ†æçµæœèˆ‡å¹´åº¦å°æ¯”\n';
            csv += 'å“é …,å»å¹´æ•¸é‡,ä»Šå¹´æ•¸é‡,æ•¸é‡æˆé•·ç‡,å»å¹´é‡‘é¡,ä»Šå¹´é‡‘é¡,é‡‘é¡æˆé•·ç‡,å»å¹´æ¯›åˆ©,ä»Šå¹´æ¯›åˆ©,æ¯›åˆ©æˆé•·ç‡,å»å¹´æ¯›åˆ©ç‡,ä»Šå¹´æ¯›åˆ©ç‡,æ¯›åˆ©ç‡å·®ç•°\n';
            
            targetCategories.forEach(category => {
                const stats = data.categories[category];
                const profitA = stats.amtA - stats.costA;
                const profitB = stats.amtB - stats.costB;
                const profitRateA = stats.amtA > 0 ? (profitA / stats.amtA * 100) : 0;
                const profitRateB = stats.amtB > 0 ? (profitB / stats.amtB * 100) : 0;
                
                csv += `${category},${Math.round(stats.qtyA)},${Math.round(stats.qtyB)},`;
                csv += `${stats.qtyA !== 0 ? ((stats.qtyB - stats.qtyA) / stats.qtyA * 100).toFixed(2) : 0}%,`;
                csv += `${Math.round(stats.amtA)},${Math.round(stats.amtB)},`;
                csv += `${stats.amtA !== 0 ? ((stats.amtB - stats.amtA) / stats.amtA * 100).toFixed(2) : 0}%,`;
                csv += `${Math.round(profitA)},${Math.round(profitB)},`;
                csv += `${profitA !== 0 ? ((profitB - profitA) / profitA * 100).toFixed(2) : 0}%,`;
                csv += `${profitRateA.toFixed(2)}%,${profitRateB.toFixed(2)}%,`;
                csv += `${(profitRateB - profitRateA).toFixed(2)}%\n`;
            });

            // ç¬¬äºŒéƒ¨åˆ†ï¼šCare ç”¢å“æ­å”®ç‡åˆ†æ
            csv += '\n\nCare ç”¢å“æ­å”®ç‡åˆ†æ\n';
            csv += 'ç”¢å“é¡åˆ¥,å»å¹´ST,å»å¹´AC+å¥—æ•¸,å»å¹´AC+é‡‘é¡,å»å¹´æ­å”®ç‡,ä»Šå¹´ST,ä»Šå¹´AC+å¥—æ•¸,ä»Šå¹´AC+é‡‘é¡,ä»Šå¹´æ­å”®ç‡,YoY ST,YoY AC+å¥—æ•¸,YoY AC+é‡‘é¡,YoY æ­å”®ç‡\n';
            
            const careProducts = [
                { name: 'CPU', class5: 'CPU', mainCategory: 'CPU' },
                { name: 'iPad', class5: 'iPad', mainCategory: 'iPad' },
                { name: 'iPhone', class5: 'iPhone', mainCategory: 'iPhone' },
                { name: 'AW', class5: 'AW', mainCategory: 'Apple Watch' },
                { name: 'AirPods', class5: 'Audio', mainCategory: 'AirPods' }  // Audio class5 â†’ é¡¯ç¤ºç‚º AirPods
            ];

            // ç¸½è¨ˆè®Šæ•¸
            let totalCareQtyA = 0, totalCareQtyB = 0, totalCareAmtA = 0, totalCareAmtB = 0;
            let totalMainQtyA = 0, totalMainQtyB = 0;

            careProducts.forEach(product => {
                const careData = data.careByClass5[product.class5] || { qtyA: 0, qtyB: 0, amtA: 0, amtB: 0 };
                const careQtyA = careData.qtyA;  // å»å¹´
                const careQtyB = careData.qtyB;  // ä»Šå¹´
                const careAmtA = careData.amtA;
                const careAmtB = careData.amtB;

                // ç´¯åŠ åˆ°ç¸½è¨ˆ
                totalCareQtyA += careQtyA;
                totalCareQtyB += careQtyB;
                totalCareAmtA += careAmtA;
                totalCareAmtB += careAmtB;

                // ä¸»æ©Ÿæ•¸é‡ï¼ˆSTï¼‰
                const mainQtyA = data.categories[product.mainCategory].qtyA;  // å»å¹´
                const mainQtyB = data.categories[product.mainCategory].qtyB;  // ä»Šå¹´

                // ç´¯åŠ ä¸»æ©Ÿæ•¸é‡
                if (product.mainCategory !== 'Care') {
                    totalMainQtyA += mainQtyA;
                    totalMainQtyB += mainQtyB;
                }

                // æ­å”®ç‡
                const rateA = mainQtyA > 0 ? (careQtyA / mainQtyA * 100) : 0;
                const rateB = mainQtyB > 0 ? (careQtyB / mainQtyB * 100) : 0;
                const rateDiff = rateB - rateA;

                // YoY æˆé•·ç‡
                const stGrowth = mainQtyA !== 0 ? ((mainQtyB - mainQtyA) / mainQtyA * 100) : 0;
                const qtyGrowth = careQtyA !== 0 ? ((careQtyB - careQtyA) / careQtyA * 100) : 0;
                const amtGrowth = careAmtA !== 0 ? ((careAmtB - careAmtA) / careAmtA * 100) : 0;

                csv += `${product.name},`;
                csv += `${Math.round(mainQtyA)},${Math.round(careQtyA)},${Math.round(careAmtA)},${rateA.toFixed(2)}%,`;
                csv += `${Math.round(mainQtyB)},${Math.round(careQtyB)},${Math.round(careAmtB)},${rateB.toFixed(2)}%,`;
                csv += `${stGrowth.toFixed(2)}%,${qtyGrowth.toFixed(2)}%,${amtGrowth.toFixed(2)}%,${rateDiff.toFixed(2)}%\n`;
            });

            // åŠ å…¥ç¸½è¨ˆåˆ—
            const totalStGrowth = totalMainQtyA !== 0 ? ((totalMainQtyB - totalMainQtyA) / totalMainQtyA * 100) : 0;
            const totalQtyGrowth = totalCareQtyA !== 0 ? ((totalCareQtyB - totalCareQtyA) / totalCareQtyA * 100) : 0;
            const totalAmtGrowth = totalCareAmtA !== 0 ? ((totalCareAmtB - totalCareAmtA) / totalCareAmtA * 100) : 0;
            const totalRateA = totalMainQtyA > 0 ? (totalCareQtyA / totalMainQtyA * 100) : 0;
            const totalRateB = totalMainQtyB > 0 ? (totalCareQtyB / totalMainQtyB * 100) : 0;
            const totalRateDiff = totalRateB - totalRateA;

            csv += `ç¸½è¨ˆ,`;
            csv += `${Math.round(totalMainQtyA)},${Math.round(totalCareQtyA)},${Math.round(totalCareAmtA)},${totalRateA.toFixed(2)}%,`;
            csv += `${Math.round(totalMainQtyB)},${Math.round(totalCareQtyB)},${Math.round(totalCareAmtB)},${totalRateB.toFixed(2)}%,`;
            csv += `${totalStGrowth.toFixed(2)}%,${totalQtyGrowth.toFixed(2)}%,${totalAmtGrowth.toFixed(2)}%,${totalRateDiff.toFixed(2)}%\n`;

            // ç”¢ç”Ÿä¸‹è¼‰
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `store_report_${currentStore}_${today}.csv`);
            link.click();
        }
    </script>
</body>
</html>
